---
title: Deploying a Next.js app alongside a Vue.js app on Vercel (Revival of the Blog)
date: '2024-01-16'
tags: ['content security policy', 'csp', 'google analytics', 'next.js', 'vercel', 'vercel.json', 'vue.js']
draft: true
---

import {ImageWithCaption} from '@/components/ImageWithCaption'
import {TweetIntent} from '@/components/TweetIntent'
import TOCInline from "pliny/ui/TOCInline";

<TOCInline toc={props.toc} toHeading={3} />

If you want to go jump straight to the how it was done, [click here](#the-issues)

## Intro

Just to give a bit of history, the original blog was a WordPress installation on hosted on HostGator.

<ImageWithCaption image={
    <img alt="mikedidomizio.com in 2016-03-23" src="/static/images/revival-of-the-blog/mikedidomiziocom-20160323193610.webp" />}
                  caption="It ain't much, but it's honest work." />

2013 was a long time ago. I asked ChatGPT (that didn't exist then) "what are
10 software development events that happened in 2013."

- Launch of iOS 7
- Introduction of Android KitKat
- GitHub reaches 10 million repositories
- Docker 1.0 Release
- Node.js and io.js Split
- Launch of AngularJS 1.2
- Rise of Continuous Delivery

and the rest happened in 2014 (oh ChatGPT), so I asked for more:

- jQuery 2.0 Release
- Node.js 0.10 Release
- Launch of Bootstrap 3

A lot has changed since that time.

When I initially created the blog, using WordPress was the obvious choice.
Although I haven't used it in forever, I'm confident that, for many purposes,
WordPress is still the de facto choice.

## The Blog ShutDown

I hosted my site with HostGator because they were popular and affordable.
I decided to shut it down at one point though because it was just unnecessary hosting costs.
I was working a new job, I wasn't writing anything. I was still doing the occasional
OSS contribution and small projects. The hosting was costing me a few bucks a month, and I felt it wasn't worth continuing so I decided to cut it.

## The move to AWS S3

I decided to remove the blog and just have by resume/CV up.
By removing the blog, which required a database, I could just opt for a static site solution.

At that time my CV was just HTML/CSS so moving it into an S3 bucket and pointing the domain to the bucket was a viable solution.

Mid-2020 I moved my CV into [source control](https://github.com/mikedidomizio/mikedidomizio-resume/commit/31760f20710a4a369e6cb115ebb769663db49323).
This allowed me to have a history of changes, and allow me to revert if I needed.
It was also just nice to see a progression over time as skills and line items changed.

At the start of 2021, I [converted the project](https://github.com/mikedidomizio/mikedidomizio-resume/commit/81a17712c0edbd1b95dcddf1793fefd6a02ce27c) to use Vue.js.
I wanted to have easy to maintain consistency throughout the application. Which could be done by breaking the CV into components.

When I pushed to the default branch, it would build it and deploy the static build to S3.

## Busy in 2023

Late 2023 after working on a number of personal projects I wanted to get back into more writing.
My original thought was to go back to WordPress, then deploy a static build with Remix.

I started building out my own Next.js implementation.  My only issues:

- It was not very pretty, but I looked at a few others in the industry (like [Dan Abramov](https://overreacted.io/) and [Lee Robinson](https://leerob.io/)) and they have decided to keep things simple. I felt it was acceptable.

but the biggest thing was:

- The time of building it

I just wanted to write, not code from scratch a blog.

I found this [Next.js Tailwind Starter Blog](https://github.com/timlrx/tailwind-nextjs-starter-blog) and it looked good and seemed to fit all my needs.
My plan was to deploy with Vercel to keep things simple.

## The issues

The first issue was how was I going to deploy a Next.js app and Vue.js app together on Vercel under the same domain?

- https://mikedidomizio.com/resume is a [Vue.js application](https://github.com/mikedidomizio/mikedidomizio-resume).
- https://mikedidomizio.com (and all other routes) is a [Next.js application](https://github.com/mikedidomizio/mikedidomizio.com).

My first thought was do I set it up as a monorepo to host the two projects to be deployed together?

I didn't really want that, I (currently) like the separation of the two projects.
Two separate git histories, easy to maintain separately and if I need to separate them again, it's practically already done.

## Creating the vercel.json configuration

Vercel has the ability to include a `vercel.json` file to alter the project configuration.
I haven't [gone through all of the documentation](https://vercel.com/docs/projects/project-configuration) but it
seems pretty powerful and easy to use.

I wanted to have Vercel point to a different deployment if a user goes to the `/resume` endpoint. This could
be done with their [rewrites](https://vercel.com/docs/projects/project-configuration#rewrites).

This was accomplished pretty simply with just having the `source` be the endpoint I wanted and the `destination` point to the other Vercel deployment:

```json
{"source": "/resume", "destination": "https://mikedidomizio-resume.vercel.app/"}
```

This can be verified working by visiting your main deployment URL and visiting the `source` endpoint and verifying if that goes to the `destination`.

I was immediately hit with one issue though, CSS/JS not loading properly.
The simple solution would be to also forward those routes as well, but I chose to have Vue build to differentiate
these files as `resume-*` directories/files.

Going from this:

```
app/
├── css/
│   └── app.css.{HASH}.css
├── js/
│   ├── app.{HASH}.js
│   └── chunk-vendors.{HASH}.js
└── index.html
```

to this:

```
app/
├── resume-css.app.css.{HASH}.css
├── resume-js/
│   ├── app.{HASH}.js
│   └── chunk-vendors.{HASH}.js
└── index.html
```

by changing the Vue.js configuration (`vue.config.js`) to include

```
// all CSS files to be prefixed with `resume-css`
chainWebpack: (config) => {
  if (process.env.NODE_ENV === 'production') {
    config
      .plugin('extract-css')
      .tap((args) => {
        args[0].filename = 'resume-css.[name].[contenthash:8].css';
        args[0].chunkFilename = 'resume-css.[name].[contenthash:8].css';
        return args;
      })
        .end()
  }
},
// assets to be under `resume-js` directory (I just had js files but you may have other files in here and want to make the directory more generic named)
assetsDir: 'resume-js',
```

The `resume-*` prefix is not required to do, but I wanted to ensure there was less chance of conflicts.
I had to also update the Vercel configuration about these specific routes via the `rewrites` array.

```
{"source": "/resume-js/:match*", "destination": "https://mikedidomizio-resume.vercel.app/resume-js/:match*"},
{"source": "/resume-css:match(.*)", "destination": "https://mikedidomizio-resume.vercel.app/resume-css:match*"},
```

The Vercel configuration change is mandatory, but would differ if you choose a different route.

## Content Security Policy issues

### Google Fonts

The next problem was that the Google fonts under the endpoint `/resume` were not loading properly,
but were working properly under the `vercel.app` deployments.

I updated the `vercel.json` file to include CSP for that `/resume` endpoint

```json
{
  "key": "Content-Security-Policy",
  "value": "default-src 'self'; font-src 'self' fonts.gstatic.com; style-src 'self' fonts.googleapis.com; img-src 'self' data:;"
}
```

This allowed me to get around Google Fonts being blocked, which can be verified that the font loads, either visually or by the network panel of your browser.
Some other options would have been nonces and hashes, but this felt like the quickest and simplest solution.

### Google Analytics CSP

Google Analytics (sometimes referred here as GA) was also blocked by CSP. The main site had not been setup and the Resume/CV Google Analytics
was no longer working properly.

The Resume/CV deployment required changes to the `vercel.json` file, that can be quickly taken from [here](https://developers.google.com/tag-platform/security/guides/csp#google_analytics_4_google_analytics).
The rest of the document will be working towards Google Analytics 4.

Adding a hash to avoid using [unsafe-inline](https://content-security-policy.com/unsafe-inline/).

This is a [quick read](https://content-security-policy.com/hash/) on hashes with CSP that I found helpful.
It tells you how to get the hash via command or through the console error which it did for me:

```
Refused to execute inline script because it violates the following Content Security Policy directive: "script-src-elem 'self' *.googletagmanager.com". Either the 'unsafe-inline' keyword, a hash ('sha256-NWf2QfXgstC58zeipPN/8CH5ZLaYLMFh0+dDWU0xbcY='), or a nonce ('nonce-...') is required to enable inline execution.
```

Modifying the content security policy to be such:

```text
script-src-elem 'self' *.googletagmanager.com 'sha256-NWf2QfXgstC58zeipPN/8CH5ZLaYLMFh0+dDWU0xbcY='
```

and updating the `<script>` tag in the Vue.js project to include the hash:

```html
<script integrity="sha256-NWf2QfXgstC58zeipPN/8CH5ZLaYLMFh0+dDWU0xbcY=" crossorigin="anonymous">
```

> Note that the above example is also using subresource integrity or SRI to enforce the hash. You might find it duplicating to have it in both places, but it can serve as a good way to document which hash is for which script.

You can verify the above works by loading up Google Analytics Real Time dashboard, visiting the endpoint in another tab and see if it GA reports a new user.

Finally updating the main site [next.config.js](https://github.com/mikedidomizio/mikedidomizio.com/commit/5aa5da52073239e3ba60c790559901a64d560755) [headers](https://nextjs.org/docs/app/api-reference/next-config-js/headers) to use the values needed for it.

ℹ️ This is modified to be copy/pasted and not exactly what is applied to this project. If it doesn't work check out the `next.config.js`
in this repo and let me know.

```
// all routes to have this CSP header
async headers() {
  return [
    {
      source: '/(.*)',
      headers: [
        {
          key: 'Content-Security-Policy',
          value: `
            default-src 'self';
            script-src 'self' https://*.googletagmanager.com;
            style-src 'self';
            img-src * blob: data: https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com
              https://*.g.doubleclick.net https://*.google.com https://*.google.com;
            font-src 'self';
          `
        },
      ],
    },
  ]
},
```

You can verify the above by going to any other endpoint and changing pages and verifying that Google Analytics reports the other pages.

The CSP stuff can be a bit tricky but the errors I find are pretty telling of what is going on. Read the CSP links in this post, and break down the errors that your browser reports.

## Shout Outs

[content-security-policy.com](https://content-security-policy.com/) is a really nice website and good resource regarding CSP.

## Maintenance

This should be fairly stable with Google Analytics 4 but with third party requests it's always possible things change.
Vercel/Next changes may require updates to continue this properly being deployed.

As of writing this the versions used in these projects are:

- `"next": "14.0.3",`
- `"vue": "^2.6.11"`

This post may be updated periodically but the majority of the work was done between 2024-01-01 and 2024-01-15.
If significant time has passed since this has been published consider that some of it may be out of date.

## Conclusion

By configuring Vercel it was fairly simple to get two separate apps working alongside together.
It does take understanding what has to be done to get it to work right but once understood it worked nicely 🎉.

Have you done a similar setup? Better? More complicated? I'm curious.
<TweetIntent text="Let me know!" tweet="@Mike_DiDomizio re:deploying multi apps under via Vercel." />
